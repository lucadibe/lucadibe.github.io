<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NILE - Dashboard</title>
    <script data-memberstack-app="app_cmlf9re4g00u40ss19rl32mj9" src="https://static.memberstack.com/scripts/v2/memberstack.js" type="text/javascript"></script>
    
    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 20px; 
        }

        /* HEADER */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 1px solid #1e293b; 
            padding-bottom: 20px; 
            position: relative;
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        .dashboard-title { font-size: 2rem; font-weight: 800; margin: 0; color: #f8fafc; }
        
        /* NUOVO TITOLO CENTRALE */
        .brand-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: #38bdf8;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .user-info { text-align: right; font-size: 0.9rem; color: #94a3b8; }
        .update-time { color: #22c55e; font-weight: bold; display: block; margin-bottom: 5px; }

        button.logout-btn {
            background: transparent; border: 1px solid #334155; color: #94a3b8; 
            padding: 5px 15px; border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        button.logout-btn:hover { border-color: #ef4444; color: #ef4444; }

        /* KPI STATS - RIMOSSI I CONTATORI NUMERICI */
        .stats-container { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .stat-box { 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .bg-green { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .bg-red { background: rgba(220, 38, 38, 0.2); color: #f87171; }

        /* TABELLA */
        .table-container { 
            overflow-x: auto; 
            background: #1e293b; 
            border-radius: 12px; 
            border: 1px solid #334155; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        
        th, td { 
            padding: 12px 16px; 
            text-align: left; 
            border-bottom: 1px solid #334155; 
            font-size: 0.95rem; 
            white-space: nowrap;
        }
        th { 
            background: #0f172a; 
            color: #94a3b8; 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        /* Input filtri */
        .filter-input {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            color: #cbd5e1;
            padding: 6px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.8rem;
            box-sizing: border-box; 
        }
        .filter-input:focus { outline: none; border-color: #38bdf8; }

        /* Celle specifiche */
        .badge { padding: 4px 10px; border-radius: 4px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .badge-buy { background: rgba(74, 222, 128, 0.1); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.2); }
        .badge-sell { background: rgba(248, 113, 113, 0.1); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.2); }
        
        .pos-var { color: #4ade80; font-weight: 600; }
        .neg-var { color: #f87171; font-weight: 600; }
        
        .ticker-style { font-weight: 700; color: #38bdf8; font-size: 1rem; }

        /* Watchlist Star */
        .star-icon { cursor: pointer; font-size: 1.2rem; color: #475569; transition: color 0.2s; }
        .star-icon.active { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .filter-star-toggle { cursor: pointer; font-size: 1.2rem; color: #475569; }
        .filter-star-toggle.enabled { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }

        @media (max-width: 768px) {
            .brand-title { position: static; transform: none; display: block; margin: 10px 0; text-align: center; }
            .header { flex-direction: column; align-items: stretch; gap: 10px; }
            .header-left { justify-content: space-between; }
            .user-info { text-align: center; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <h1 class="dashboard-title">Dashboard</h1>
            <button class="logout-btn" data-ms-action="logout">LOGOUT</button>
        </div>
        
        <div class="brand-title">NILE - Follow the Trend</div>

        <div class="user-info">
            <span class="update-time">‚óè AUTO-UPDATE 4:00 AM Italian time</span>
            <span data-ms-member="email">Loading...</span>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-box bg-green" id="greenFlip">% GREEN SINCE FLIP W: 0%</div>
        <div class="stat-box bg-red" id="redFlip">% RED SINCE FLIP W: 0%</div>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th onclick="handleSort(0)">Ticker <input type="text" class="filter-input" placeholder="üîç Ticker" onkeyup="filterTable()"></th>
                    <th onclick="handleSort(1)">Market <input type="text" class="filter-input" placeholder="Market..." onkeyup="filterTable()"></th>
                    <th onclick="handleSort(2)">Sector <input type="text" class="filter-input" placeholder="Sector..." onkeyup="filterTable()"></th>
                    <th onclick="handleSort(3)">Industry <input type="text" class="filter-input" placeholder="Industry..." onkeyup="filterTable()"></th>
                    <th onclick="handleSort(4)">Last Price <input type="text" class="filter-input" placeholder="Filter..." onkeyup="filterTable()"></th>
                    <th onclick="handleSort(5)">Trend W <input type="text" class="filter-input" placeholder="Filter..." onkeyup="filterTable()"></th>
                    <th onclick="handleSort(6)">Price Since Flip W <input type="text" class="filter-input" placeholder="Filter..." onkeyup="filterTable()"></th>
                    <th onclick="handleSort(7)">Var % W <input type="text" class="filter-input" placeholder="Filter..." onkeyup="filterTable()"></th>
                    <th style="text-align: center;">
                        MY WATCHLIST <span id="watchlistToggle" class="filter-star-toggle" onclick="toggleWatchlistFilter()">‚òÖ</span>
                    </th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdzNpQjqwdqK5ZO16Kd8hlNNtmm31gxOy1AAb49CDXqxMwEOmUpowc9H4rHWPbb9rd874zmOtcDTUo/pub?gid=1410987574&single=true&output=csv';
        let favorites = JSON.parse(localStorage.getItem('myWatchlist')) || [];
        let watchlistOnly = false;
        let currentSort = { column: null, ascending: true };

        // --- FETCH E PARSING DATI ---
        async function update() {
            try {
                const res = await fetch(csvUrl + '&nocache=' + Date.now());
                const text = await res.text();
                const sep = text.includes(';') ? ';' : ',';
                const lines = text.split(/\r?\n/);
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                lines.forEach((line, index) => {
                    if (index === 0 || !line) return; // Salta intestazione CSV e righe vuote
                    
                    const c = parseCSVLine(line, sep);
                    const ticker = c[0] || "";
                    if (ticker.length < 2) return; // Salta righe non valide

                    // MAPPATURA COLONNE (Solo Weekly, rimosso Daily)
                    const market = c[1]||"";
                    const sector = c[17]||"-";
                    const industry = c[18]||"-";
                    const lastP = c[14]||"-";
                    const trendW = c[4]||"";
                    const flipW = c[6]||"";
                    const varW = c[15]||"-";

                    const isFav = favorites.includes(ticker);
                    
                    // FORMATTAZIONE CELLE
                    const formatSign = v => v.toUpperCase().includes('BUY') ? `<span class="badge badge-buy">${v}</span>` : v.toUpperCase().includes('SELL') ? `<span class="badge badge-sell">${v}</span>` : v;
                    
                    const formatVar = v => {
                        if (v === "-") return v;
                        const n = parseFloat(v.replace(',','.').replace('%',''));
                        return isNaN(n) ? v : `<span class="${n>0?'pos-var':n<0?'neg-var':''}">${v}</span>`;
                    };

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="ticker-style">${ticker}</td>
                        <td style="font-style:italic; color:#94a3b8;">${market}</td>
                        <td>${sector}</td>
                        <td>${industry}</td>
                        <td style="font-weight:bold; color:#fff;">${lastP}</td>
                        <td>${formatSign(trendW)}</td>
                        <td>${flipW}</td>
                        <td>${formatVar(varW)}</td>
                        <td style="text-align: center;" data-val="${isFav?'YES':'NO'}">
                            <span class="star-icon ${isFav?'active':''}" onclick="toggleFavorite('${ticker}',this)">‚òÖ</span>
                        </td>`;
                    tbody.appendChild(tr);
                });

                filterTable();
                updateCounters();

            } catch (e) { console.error("Update Error:", e); }
        }

        // --- PARSER CSV ROBUSTO ---
        function parseCSVLine(line, sep) {
            const result = [];
            let cur = '', inQuotes = false;
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === sep && !inQuotes) { result.push(cur.trim()); cur = ''; }
                else cur += char;
            }
            result.push(cur.trim());
            return result;
        }

        // --- GESTIONE PREFERITI ---
        function toggleFavorite(ticker, element) {
            const index = favorites.indexOf(ticker);
            if (index > -1) {
                favorites.splice(index, 1);
                element.classList.remove('active');
                element.closest('td').setAttribute('data-val', 'NO');
            } else {
                favorites.push(ticker);
                element.classList.add('active');
                element.closest('td').setAttribute('data-val', 'YES');
            }
            localStorage.setItem('myWatchlist', JSON.stringify(favorites));
            filterTable(); // Aggiorna se siamo in vista "Solo Preferiti"
        }

        function toggleWatchlistFilter() {
            watchlistOnly = !watchlistOnly;
            document.getElementById('watchlistToggle').classList.toggle('enabled', watchlistOnly);
            filterTable();
        }

        // --- FILTRI ---
        function filterTable() {
            const inputs = document.getElementsByClassName("filter-input");
            const rows = document.getElementById("tableBody").getElementsByTagName("tr");
            
            for (let row of rows) {
                let show = true;
                
                // 1. Filtro Watchlist
                if (watchlistOnly && row.cells[8].getAttribute('data-val') !== 'YES') show = false;
                
                // 2. Filtri Colonne
                if (show) {
                    for (let j = 0; j < inputs.length; j++) {
                        let f = inputs[j].value.toUpperCase();
                        if (f && !row.cells[j].innerText.toUpperCase().includes(f)) { show = false; break; }
                    }
                }
                row.style.display = show ? "" : "none";
            }
            updateCounters(); // Ricalcola i KPI in base alle righe visibili
        }

        // --- ORDINAMENTO ---
        function handleSort(n) {
            if (currentSort.column === n) currentSort.ascending = !currentSort.ascending;
            else { currentSort.column = n; currentSort.ascending = true; }
            sortTable(n);
        }

        function sortTable(n) {
            const tbody = document.getElementById("tableBody");
            const rows = Array.from(tbody.rows);
            rows.sort((a, b) => {
                let valA = (n===8) ? a.cells[n].getAttribute('data-val') : a.cells[n].innerText;
                let valB = (n===8) ? b.cells[n].getAttribute('data-val') : b.cells[n].innerText;
                
                let x = valA.toLowerCase().replace('%','').replace(',','.');
                let y = valB.toLowerCase().replace('%','').replace(',','.');
                
                let numX = parseFloat(x), numY = parseFloat(y);
                let res = (!isNaN(numX) && !isNaN(numY)) ? numX - numY : x.localeCompare(y);
                
                return currentSort.ascending ? res : -res;
            });
            rows.forEach(r => tbody.appendChild(r));
        }

        // --- KPI AGGIORNATI (SOLO % GREEN/RED) ---
        function updateCounters() {
            let buyCount = 0; let buyGreen = 0; let buyRed = 0;
            const rows = document.getElementById("tableBody").getElementsByTagName("tr");
            
            for (let row of rows) {
                if (row.style.display !== "none") {
                    let trendW = row.cells[5].innerText.toUpperCase();
                    let varWStr = row.cells[7].innerText.replace(',', '.').replace('%', '').trim();
                    let varW = parseFloat(varWStr);
                    
                    if (trendW.includes("BUY")) {
                        buyCount++;
                        if (!isNaN(varW)) { 
                            if (varW > 0) buyGreen++; 
                            else if (varW < 0) buyRed++; 
                        }
                    }
                }
            }
            
            let greenPerc = buyCount > 0 ? Math.round((buyGreen / buyCount) * 100) : 0;
            let redPerc = buyCount > 0 ? Math.round((buyRed / buyCount) * 100) : 0; // O (100 - greenPerc)

            document.getElementById("greenFlip").innerText = `% GREEN SINCE FLIP W: ${greenPerc}%`;
            document.getElementById("redFlip").innerText = `% RED SINCE FLIP W: ${redPerc}%`;
        }

        // --- MEMBERSTACK & INIT ---
        window.addEventListener('load', async () => {
            const memberstack = window.$memberstackDom;
            const { data: member } = await memberstack.getCurrentMember();
            if (member) {
                // Utente loggato: avvia tutto
                update();
            } else {
                // Utente non loggato: redirect alla home
                window.location.href = "index.html";
            }
        });
    </script>
</body>
</html>
